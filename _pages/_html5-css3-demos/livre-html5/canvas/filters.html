<!doctype html>
<html>
<head>
	<style>
	canvas{border:1px solid}
	</style>
	<script src="canvas2image.js"></script>
</head>
<body>
<canvas id="mycanvas" width="500" height="300">
	Il faut vivre avec son temps mon vieux !
</canvas>


<a href="#" id="save">Save</a>
<script>
	var oCtx = null;

	window.addEventListener('load', function() {
		oCtx = document.getElementById("mycanvas").getContext("2d");
		//dessinerFond();
		dessinerLogo();
		
	}, false);
	
	function dessinerLogo(){
		var oLogo = new Image();
		oLogo.src = "logohtml5.png";	
		oLogo.onload = function(){
			oCtx.drawImage(oLogo, 120, 20);
			filtreNoirEtBlanc();
		};
	}	
	
	function dessinerFond(){
		var oMiniLogo = new Image();
		oMiniLogo.src = "minilogohtml5.png";	
		oMiniLogo.onload = function(){
			oCtx.fillStyle = oCtx.createPattern(oMiniLogo, "repeat");
			oCtx.fillRect(0, 0, 500, 300);
		
			};
	}	
		
	
function filtreNoirEtBlanc(){
  var oImageData = oCtx.getImageData(0, 0,
                                     oCtx.canvas.width,
                                     oCtx.canvas.height);
  for (var i = 0; i < oImageData.data.length; i = i + 4){
    var iGray = (oImageData.data[i] * 0.3 +
                 oImageData.data[i + 1] * 0.59 +
                 oImageData.data[i + 2] *0.11);
    oImageData.data[i] = iGray;
    oImageData.data[i + 1] = iGray;
    oImageData.data[i + 2] = iGray;
  }
  oCtx.putImageData(oImageData, 0, 0);				
}
	
	/*
	function drawCat(ctx){
		var cat = new Image();
		cat.src = "cat.jpg";	
		cat.onload = function(){
			oCtx.drawImage(cat, 0, 0);
			var imageData = oCtx.getImageData(0, 0, 489, 367);
			
			for (var i = 0; i<= imageData.data.length; i = i + 4){
				
				var grayscale = (imageData.data[i] * 0.3 +
								 imageData.data[i + 1] * 0.59 +
								 imageData.data[i + 2] *0.11);
				
				imageData.data[i] = grayscale;
				imageData.data[i + 1] = grayscale;
				imageData.data[i + 2] = grayscale;
				}
				oCtx.putImageData(imageData, 0, 0);
				
		};
	}
	
	function drawCat2(ctx){
		var cat = new Image();
		cat.src = "cat.jpg";	
		cat.onload = function(){
			oCtx.drawImage(cat, 0, 0);
			var imageData = oCtx.getImageData(0, 0, 489, 367);
			var reverted = oCtx.createImageData(489, 367);
			var j = 0;
			for (var i = imageData.data.length -4; i> 4; i = i - 4){
				reverted.data[j] = imageData.data[i];
				reverted.data[j + 1] = imageData.data[i + 1];
				reverted.data[j + 2] = imageData.data[i + 2];
				reverted.data[j + 3] = imageData.data[i + 3];
				j = j + 4;
			}

				
				oCtx.putImageData(reverted, 0, 0);
		};
	}
*/
	document.getElementById("save").addEventListener('click', function() {
		//Canvas2Image.saveAsPNG( document.getElementById("mycanvas"));
		//window.open(ctx.canvas.toDataURL('image/png'));
		window.location = oCtx.canvas.toDataURL("image/png");
		//var strDataURI = ctx.canvas.toDataURL("image/png;base64"); document.write(strDataURI);
		
	}, false);	
	
	</script>
</body>
</html>